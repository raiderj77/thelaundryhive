rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user belongs to tenant
    function isTenantMember(tenantId) {
      return request.auth != null && request.auth.token.tenantId == tenantId;
    }

    // Helper function to check if user is Super Admin
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'super_admin';
    }

    // Tenants Collection
    // Only Super Admins can create/delete tenants
    // Members can read their own tenant config
    match /tenants/{tenantId} {
      allow read: if isTenantMember(tenantId) || isSuperAdmin();
      allow write: if isSuperAdmin();

      // Orders Subcollection
      match /orders/{orderId} {
        allow read, write: if isTenantMember(tenantId);
      }

      // Customers Subcollection
      match /customers/{customerId} {
        allow read, write: if isTenantMember(tenantId);
      }

      // Products/Inventory
      match /products/{productId} {
        allow read: if true; // Public for storefront
        allow write: if isTenantMember(tenantId);
      }
    }

    // Usage Logs (Billing)
    // Only writable by backend (Cloud Functions)
    // Readable by Super Admin
    match /usage_logs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only via Admin SDK
    }
  }
}
